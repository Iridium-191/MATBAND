%读取midi文件，获得NMAT矩阵
A2=readmidi('lemon.mid');
%音符的频率矩阵
N=[16.3520000000000;17.3240000000000;18.3540000000000;19.4450000000000;20.6020000000000;21.8270000000000;23.1250000000000;24.5000000000000;25.9570000000000;27.5000000000000;29.1350000000000;30.8680000000000;32.7030000000000;34.6480000000000;36.7080000000000;38.8910000000000;41.2030000000000;43.6540000000000;46.2490000000000;48.9990000000000;51.9130000000000;55;58.2700000000000;61.7350000000000;65.4060000000000;69.2960000000000;73.4160000000000;77.7820000000000;82.4070000000000;87.3070000000000;92.4990000000000;97.9990000000000;103.830000000000;110;116.540000000000;123.470000000000;130.810000000000;138.590000000000;146.830000000000;155.560000000000;164.810000000000;174.610000000000;185;196;207.650000000000;220;233.080000000000;246.940000000000;261.630000000000;277.180000000000;293.660000000000;311.130000000000;329.630000000000;349.230000000000;369.990000000000;392;415.300000000000;440;466.160000000000;493.880000000000;523.250000000000;554.370000000000;587.330000000000;622.250000000000;659.260000000000;698.460000000000;739.990000000000;783.990000000000;830.610000000000;880;932.330000000000;987.770000000000;1046.50000000000;1108.70000000000;1174.70000000000;1244.50000000000;1318.50000000000;1396.90000000000;1480;1568;1661.20000000000;1760;1864.70000000000;1975.50000000000;2093;2217.50000000000;2349.30000000000;2489;2637;2793.80000000000;2960;3136;3322.40000000000;3520;3729.30000000000;3951.10000000000;4186;4434.90000000000;4698.60000000000;4978;5274;5587.70000000000;5919.90000000000;6271.90000000000;6644.90000000000;7040;7458.60000000000;7902.10000000000;8372;8869.80000000000;9397.30000000000;9956.10000000000;10548;11175;11840;12544;13290;14080;14917;15804];
%读取NMAT矩阵中的关键元素，包括元素（音素）的起止时间，音量等
notes=A2(:,4)-12;
start=A2(:,6);
ennd=A2(:,7);
vel=A2(:,5);
%设置波特率
fs=48000;
tt=0:1/fs:(start(end)+ennd(end));
lt=length(tt);
snd=zeros(lt,1);
%音符的合成与加工
for i=1:length(notes)
    fre=N(notes(i)-1);
    %频率函数，详见音色合成教程
    f=@(x)sin(2*pi*fre*x+pi)+258.4/142.4*sin(4*pi*fre*x-pi)+118.6/142.4*sin(6*pi*fre*x-2.308)+111.6/142.4*sin(8*pi*fre*x);
    x=0:1/fs:ennd(i);
    wave=f(x);
    xx=[0 0.2 0.25 0.3 0.35 0.4 0.6 0.7 0.8 0.9 1];
    hh=[];
    y=[0 2.5 1.95 1.8 1.7 1.7 1.7 1.7 0.8 0.3 0];
    for j=1:length(xx)
        hh=[hh x(length(0:1/fs:xx(j)*ennd(i)))];
    end
    %ADSR包络
    fk=spline(hh,y,x);
    note=fk.*wave;
    %对于音符的合成和拼接
    if i==1
        b=zeros(lt-length(note),1);
        uu=[note';b];
        uu=uu/max(uu);
        uu=uu*vel(i)/max(vel);
    elseif i==length(notes)
        b=zeros(lt-length(note),1);
        uu=[b;note'];
        uu=uu/max(uu);
        uu=uu*vel(i)/max(vel);
    else
        a=zeros(length(0:1/fs:start(i)),1);
        b=zeros(lt-length(a)-length(note),1);
        uu=[a;note';b];
        uu=uu/max(uu);
        uu=uu*vel(i)/max(vel);
    end
    snd=snd+uu;
end
%防止音色爆炸，削减幅度
snd=0.5*snd;
%混响的简单实现（延时，削除回波，拼接）
 hhh=zeros(100,1);
snd2=[hhh;snd];
snd3=0.1*[snd;hhh];
snds=snd2+snd3;
%写音频文件
audiowrite('lemon.wav',snd,fs);